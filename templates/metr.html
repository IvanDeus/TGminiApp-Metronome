<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metronome</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="credits">[ ivan deus ]</div>
<!-- Profile Image -->
<div id="profile-pic" style="background-image: url('{{ photo_url }}');"></div>

<div class="container">
    <div class="volume-control">
        <div class="volume-level" id="volume-level"></div>
    </div>
    <div class="controls">
        <button class="control-btn" id="tempo-down">Slower</button>
        <div class="status" id="bpm-display">BPM: ---</div>
        <button class="control-btn" id="tempo-up">Faster</button>
    </div>
</div>

<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let currentBPM = 90;
    let isPlaying = false;

    function playClick() {
        const now = audioContext.currentTime;
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        osc.type = 'square';
        osc.frequency.value = 800;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.1, now + 0.001);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.02);

        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);
        osc.start(now);
        osc.stop(now + 0.02);
    }

    function startMetronome() {
        const interval = 60000 / currentBPM;
        playClick();
        setInterval(() => {
            if (isPlaying) playClick();
        }, interval);
    }

    function updateBPMDisplay() {
        const display = document.getElementById('bpm-display');
        if (display) {
            const paddedBPM = currentBPM.toString().padStart(3, '0');
            display.textContent = `BPM: ${paddedBPM}`;
        }
    }
    // Telegram WebApp Init
    if (window.Telegram && Telegram.WebApp) {
        const initData = Telegram.WebApp.initData;
        fetch('/init_telegram', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `initData=${encodeURIComponent(initData)}`
        })
        .then(response => response.json())
        .then(data => {
            window.currentUserData = data;
            updateBPMDisplay();
        })
        .catch(error => {
            console.error('Telegram init failed:', error);
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="telegram-error">
                ${ERROR_MESSAGES['no_tg']}
                </div>`;
        });
    }
  document.getElementById('tempo-up').onclick = () => {
        if (currentBPM < 320) {
            currentBPM += 4;
            updateBPMDisplay();
        }
    };
  document.getElementById('tempo-down').onclick = () => {
        if (currentBPM > 24) {
            currentBPM -= 4;
            updateBPMDisplay();
        }
    };
    // Resume AudioContext on interaction
 document.body.addEventListener('click', () => {
        if (audioContext.state === 'suspended') audioContext.resume();
    }, { once: true });
    // Disable context menu
 document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
    }, false);
</script>
</body>
</html>
